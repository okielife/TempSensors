name: Clean Old Results

on:
  schedule:
    - cron: '0 0 * * 0'  # Runs every Sunday at midnight UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: gh-pages

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create cleanup branch
        id: branch
        run: |
          TS=$(date -u +"%Y%m%d-%H%M%S")
          BRANCH="cleanup/old-posts-${TS}"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Clean old results
        run: python scripts/clean_old_results.py

      - name: Commit changes (if any)
        id: commit
        run: |
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "Remove outdated posts"
            git push origin "${{ steps.branch.outputs.branch }}"
            gh pr create --base main --head "${{ steps.branch.outputs.branch }}" --title "Weekly data cleanup" --body "PR automatically generated by a weekly GitHub Action. Review the proposed deletions and merge."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
