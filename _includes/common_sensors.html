<script src='https://cdn.plot.ly/plotly-3.3.0.min.js'></script>

<!--Make sure to set page_locations before including this, using either site.data.config.locations, or a manual array-->

{% assign sensor_ids = "" | split: '/' %}
{% for page in site.posts %}
  {% assign full_path_parts = page.path | split:'/' %}
  {% assign this_sensor_id = full_path_parts[1] | strip %}
  {% assign sensor_ids = sensor_ids | push: this_sensor_id %}
{% endfor %}
{% assign sensor_ids = sensor_ids | uniq %}

{% assign page_active_sensors = "" | split: '/' %}
{% for page_location in page_locations %}
  {% assign active_sensors_at_location = site.data.config.sensors | where_exp:"s","s.sensor_location == page_location" %}
  {% for active_sensor_at_location in active_sensors_at_location %}
    {% assign page_active_sensors = page_active_sensors | push: active_sensor_at_location %}
  {% endfor %}
{% endfor %}

<nav class="navbar navbar-expand navbar-light bg-light">
  <a class="navbar-brand" href="#">Temperature Sensor Dashboard</a>
    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="nav-link" href="{{ '/' | relative_url }}">All Locations</a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="{{ 'emerald' | relative_url }}">Emerald</a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="{{ 'pantry' | relative_url }}">Pantry</a>
      </li>
    </ul>
</nav>


{% for sensor in page_active_sensors %}
  {% assign full_sensor_history = site.posts | where: "sensor_id", sensor.id | slice: 0, 100 | reverse %}
  {% assign recent_sensor_posts = site.posts | where: "sensor_id", sensor.id | slice: 0, 5 %}
  {% assign caution_temp = sensor.maximum_temp | plus: 2 %}
  {% assign max_temp_f = sensor.maximum_temp | times: 9 | divided_by: 5 | plus: 32 %}

  <div class="container-fluid">
    <div class="row g-3">
      <div class="col-12">
        <div class="card h-100 card border-1 border-secondary shadow-sm">
          <h2 class="card-header d-flex justify-content-center align-items-center">{{ sensor.nice_name }}</h2>
          <div class="card-body">
            <div class="row g-3 align-items-stretch">
              <div class="col-12 col-md-6 d-flex">
                <div class="w-100">
                  <div class="table-responsive">
                    <table class="table table-striped table-bordered fs-6">
                <thead>
                  <tr>
                    <th style="text-align: center;">Date</th>
                    <th style="text-align: center;">Time</th>
                    <th style="text-align: center;">Temp</th>
                  </tr>
                </thead>
                <tbody>
                  {% for post in recent_sensor_posts %}
                    {% assign temp_celsius = post.temperature | round: 1 %}
                    {% assign temp_fahrenheit = post.temperature | times: 9 | divided_by: 5 | plus: 32 | round: 1 %}
                    <tr style="text-align: center;">
                      <td>
                        <span class="ts-date" data-ts="{{ post.measurement_time }}"></span>
                      </td>
                      <td>
                        <span class="ts-time" data-ts="{{ post.measurement_time }}"></span>
                      </td>
                      {% if post.temperature <= sensor.maximum_temp %}
                        <td class="temperature" style="background-color:#78c1a3">{{ temp_fahrenheit }} &degF</td>
                      {% elsif post.temperature < caution_temp %}
                        <td style="background-color:#ffdbc2">{{ temp_fahrenheit }} &degF</td>
                      {% else %}
                        <td style="background-color:#f38989">{{ temp_fahrenheit }} &degF</td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-6 d-flex">
                {% assign temp_list = "" %}
                {% assign time_list = "" %}
                {% for post in full_sensor_history %}
                  {% assign temp_fahrenheit = post.temperature | times: 9 | divided_by: 5 | plus: 32 | round: 1 %}
                  {% assign temp_list = temp_list | append: temp_fahrenheit | append: "," %}
                  {% assign parts = post.measurement_time | split: "-" %}
                  {% assign nice_time_stamp = '"' | append: parts[0] | append: "-" | append: parts[1] | append: "-" | append: parts[2] | append: " " | append: parts[3] | append: ":" | append: parts[4] | append: ":" | append: parts[5] | append: '"' %}
                  {% assign time_list = time_list | append: nice_time_stamp | append: "," %}
                {% endfor %}
                <div id="plot {{ sensor.id }}" class="w-100 flex-fill" style="width:100%;height:100%;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <hr>
  <script>
    Plotly.newPlot(
      'plot {{ sensor.id }}',
      [
        {
            x: [{{ time_list }}].map(ts => new Date(ts)),
            y: [{{ temp_list }}],
            mode: 'lines+markers',
            type: 'scatter',
            line: {color: 'rgb(50, 50, 50)'},
            name: "Sensed Temperature"
        }
      ],
      {
        showlegend: true,
        yaxis: {title: {text: 'Temperature \u00B0F'}},
        shapes: [
          {
            type: 'line',
            xref: 'paper',
            x0: 0,
            y0: 32.0,
            x1: 1,
            y1: 32.0,
            line:{color: 'rgb(0, 0, 150)', width: 2, dash: 'dot'},
            name: "Freezing Line",
            showlegend: true
          },
          {
            type: 'line',
            xref: 'paper',
            x0: 0,
            y0: {{ max_temp_f }},
            x1: 1,
            y1: {{ max_temp_f }},
            line:{color: 'rgb(150, 0, 0)', width: 2, dash: 'dot'},
            name: "Sensor Max Temp",
            showlegend: true
          }
        ]
      },
      { responsive: true }
    );
  </script>
{% endfor %}

<hr>

<div class="card">
  <div class="card-body">
    <h2 class="card-title">Temperature Measurement Information</h2>
    <p class="card-text">
      This is the dashboard for our temperature sensors.
      This dashboard is built each time a commit is made <a href="https://github.com/okielife/TempSensors">on our repository</a> by one of our sensors.
      This page shows the 5 most recent temperature measurements for each sensor in this location.
      Use the menu above to select which locations to show.
    </p>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const parse = raw => {
      const p = raw.split("-");
      return new Date(Date.UTC(p[0], p[1] - 1, p[2],p[3], p[4], p[5]));
    }
    document.querySelectorAll(".ts-date").forEach(el => {
      const d = parse(el.dataset.ts);
      el.textContent = d.toLocaleDateString();
    });
    document.querySelectorAll(".ts-time").forEach(el => {
      const d = parse(el.dataset.ts);
      el.textContent = d.toLocaleTimeString();
    });
  })
</script>